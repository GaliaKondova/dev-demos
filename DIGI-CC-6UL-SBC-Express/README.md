# Digi ConnectCore 6UL SBC Express demo

the demo demonstrates the Uniquid Identity and Access Management SDK using the uidcore-c library on ConnectCore 6UL SBC Express Digi board.

## Requirements
- Ubuntu 14.04+ with standard development tools and cmake to compile a new firmware
- Digi ConnectCore 6UL SBC Express with internet connection ([link](https://www.digi.com/products/embedded-systems/single-board-computers/connectcore-for-i-mx6ul-sbc-express))
- some software packages from digi.com ([see next chapter](#getting-started))
- libcurl
- libpthread

## Getting started
For a more detailed documentation on the board setup please refer to the DIGI web site<br>
https://www.digi.com/resources/documentation/digidocs/90002286/#landing_pages/cc6ul_index.htm

### setup the hardware (Digi ConnectCore 6UL SBC Express)
- follow this guide to setup and connect the board<br>
https://www.digi.com/resources/documentation/digidocs/90002286/task/yocto/t_set_up_hardware_yocto.htm

- follow this guide to program the Yocto firmware<br>
https://www.digi.com/resources/documentation/digidocs/90002286/task/yocto/t_program_firmware_yocto.htm<br>

### setup the development environment (host PC)
on a Linux 64-bit system (Ubuntu 14.04 or Ubuntu 16.04) follow these steps:<br>
- download the toolchain installer from the Digi support page<br>
``wget ftp://ftp1.digi.com/support/digiembeddedyocto/2.4/r1/sdk/ccimx6ulstarter/fb/dey-glibc-x86_64-core-image-base-cortexa7hf-neon-toolchain-2.4-r1.sh``

- give execution permission to the installer.<br>
``chmod +x dey-glibc-x86_64-core-image-base-cortexa7hf-neon-toolchain-2.4-r1.sh``

- install the toolchain on your host PC.<br>
``./dey-glibc-x86_64-core-image-base-cortexa7hf-neon-toolchain-2.4-r1.sh``

- each time you wish to use the SDK in a new shell session, you need to source the environment setup script e.g.<br>
``. /opt/dey/2.4-r1/environment-setup-cortexa7hf-neon-dey-linux-gnueabi``

### download the demo source code (host PC)
- clone the demo repo:<br>
``git clone git@github.com:uniquid/dev-demos.git``<br>
or<br>
``git clone https://github.com/uniquid/dev-demos.git``<br>
- change directory<br>
``cd dev-demos/DIGI-CC-6UL-SBC-Express``<br>
- download and patch the dependancy<br>
``make clone_repo``
### build the project (host PC)``
**!!make sure that the environment setup script has been sourced!!**<br>
```make```<br>
the binaries will be put on the bin directory

### transfer the executables on the board
- Power on the board using the provided USB cable<br>
- Connect the host PC using a serial terminal emulator (115200N81) or ssh<br>
- Create the demo directory under /home/root<br>
```cd /home/root```<br>
```mkdir demo```<br>
- Transfer all the content of the bin directory from the host PC to the /home/root/demo directory on the board board using sftp<br>

### copy certificates and configuration files
plese put in the demo directory the configuration file and the root CA for the mqtt broker
- aws_device_cfg.json
- rootCA.crt

they are both generated for you by the ``uniquid deploy aws`` command

### Run
- using the terminal emulator cd on /home/root/demo and type<br>
```./S99uniquid-demo start```<br>
- if you want to let start the demo on boot, copy the the provided init script on /etc/rc5.d in the board. Make sure it has execute permission on rc5.d<br>
```cp /home/root/demo/S99uniquid-demo /etc/rc5.d```

the log can be viewed with ```tail -f /var/log/uniquid-demo```

The application will create the identity and send it to the system.

The file aws_device_cfg.json will be read to load the configuration (see an  example in uidagent_c directory).
Please edit it to match your infrastructure (mqtt broker, insight-api appliance and registry service).<br>
The file is automatically generated by the ``uniquid deploy aws``


the application will create some additional files:<br>
- ``serial.no``<br>a random generated number used to give a unique name to the node<br>
- ``identity.db``<br>the cryptographic identity<br>
- ``ccache.bin`` and ``clicache.bin``<br>persistance for the contracts

you can delete these files to reset the identity.

By starting the application by pressing the user button of the board, all these files are deleted.
This causes the generation of a new identity.<br>The action is signalled by a rapid blinking of the board's user LED.

### how to use
**provider**

**demo** implements a Uniquid node with provider capabilities.
It features a LED that can be toggle between on and off status pressing the user button. The status It can be read using the uniquid RPC.<br>
Further the board publish the led status on AWS IoT (see UniquID AWS integration)<br>

The provider, in addition to the systems reserved, implements the following RPC functions:<br>

**RPC 33** - echo<br>
&nbsp;&nbsp;&nbsp;&nbsp;parameters:
- "string to be echoed" -

**RPC 34** - manage the board LED<br>
&nbsp;&nbsp;&nbsp;&nbsp;parameters:
- "on" - switch the LED on
- "off" - switch the LED off

**RPC 35** - returns the status of the LED<br>
&nbsp;&nbsp;&nbsp;&nbsp;parameters:
- "" - none

In the [directory app](app) of this dev-demos repo there is an app that is designed to be used to interact with the firmware.

### Adding functionalities to the demo code
Adding functionalities to the code is quite simple. All you need is to write the function that implements your RPC method and plug it ont the RPC engine.
The function must have the following prototipe:<br>
``void user_method(char *param, char *result, size_t size);``<br>
Where:<br>
```
param  is a string holding the value from the RPC invocation
result is a string buffer that must be filled with the results
size   is the size in bytes of the result buffer
```
Then add it to the switch case inside the function **MY_perform_request()** in the file **engine.c**<br>
A good source of information to use the uidcore-c library is ([here](https://github.com/uniquid/uidcore-demo-c))
